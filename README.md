# Nexus Claim

Define your [Sonatype Nexus](http://www.sonatype.org/nexus/) repository structure as code. This script defaults to interact with a nexus server running on [localhost](http://localhost:8081). A running nexus server is vital for executing `plan` and `apply` commands.

## Development
- Use golang 1.9 for compiling, 1.10 will lead to a segmentation fault when running the tool!

## Syntax of nexus-claim on nexus 3

```bash
$ nexus-claim plan -i input.hcl -o output.json
$ nexus-claim apply -i output.json
```

If in case of doubt, issue `nexus-claim --help` to get going.

### Global Options

```
--server value, -s value    Url to the nexus server (default: "http://localhost:8081") [$NEXUS_SERVER]
--username value, -u value  Username of a nexus admin user (default: "admin") [$NEXUS_USER]
--password value, -p value  Password of the nexus user (default: "admin123") [$NEXUS_PASSWORD]
--nexus2                    use this flag to use nexus-claim with nexus 2 [$NEXUS_V2]
--help, -h                  show help
--version, -v               print the version
```

## Testing with nexus 3

### Nexus 3 as a simple container

1. Have a Golang 1.9 installed (or make it runnable with a recent version of Go)
1. Install Golang dependencies with `glide install`
1. Build the software in the `target/` directory
   - `make clean && make`
1. Start up a local nexus
   - `docker run -d -p 8081:8081 --name nexus sonatype/nexus3`
1. Plan a custom repository `.hcl` file
   - `target/nexus-claim plan -i resources/nexus3/nexus_custom_example.hcl -o targetState.json`
   - this reads existing repositories from the nexus, changes from the given `.hcl` file will make up the target state as JSON
   - the target state is supposed to be created within the nexus-claim application
1. Apply target state `.json` file to nexus
   1. an auto-generated `.groovy` file responsible for interacting with the nexus API in terms of creating will be uploaded in the nexus.
   1. the `.groovy file` responsible for creation will be called with the target `.json` being the argument
1. The repository changes are being written. Check the nexus frontend for changes.

### Nexus 3 within a Cloudogu EcoSystem

Sometimes it is faster to jump start when a running CES already exists.

1. SSH into your CES
1. jump into the Nexus dogu
   - `docker exec -it nexus bash`
1. Export the Dogu user and password
   - see [claim script in Nexus Dogu](https://github.com/cloudogu/nexus/blob/develop/resources/claim.sh)
1. nexus-claim plan -i yourHclFile.hcl -o "-" | nexus-claim apply -i "-"

## Things to consider for .hcl of nexus 3

- on repositories of type maven2-hosted and maven2-proxy there additionally must be a maven section present (with attributes `versionPolicy` and `writePolicy`)
- Note: the `.groovy` files generated by `go generate` are only an interaction layer and should not contain larger application logic.

## Configuration Examples
 
### nexus 3

Examples can be found in the [nexus 3 resources directory](resources/nexus3/nexus_custom.hcl). Also available in the same directory are resulting target `.json` files for reference.

### nexus 2

Examples can be found in the [nexus 2 resources directory](resources/nexus2/nexus-initial-example.hcl)
